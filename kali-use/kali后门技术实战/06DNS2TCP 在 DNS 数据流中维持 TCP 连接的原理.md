# DNS2TCP 在 DNS 数据流中维持 TCP 连接的原理

## 一、实验介绍

### 1.1 实验介绍说明

本次实验是一次比较偏重理论的实验，在下面的实验文档中，将会介绍使用 DNS2TCP 在 DNS 数据流中维持 TCP 连接的原理部分。课程中主要介绍 DNS2TCP 是什么，它的使用方法，以及它的各个参数含义。实验的环境为实验楼提供的 Ubuntu 14.04。其中 Ubuntu 14.04 为宿主机，宿主机上安装有两台虚拟机。

两台虚拟机分别为 Kali Linux 和 Metasploitable2，本实验的所有操作基本是在 Kali Linux 下进行的。在这次实验的过程中，动手实践的次数比较低，主要掌握一些必要的网络连接知识，实验偏重理论部分，侧重于让同学们理解 DNS 隧道技术的原理。以及 TCP。UDP 等协议的具体内容。对于这些概念性知识，会在接下来的试验中逐一讲解。

**注意：实验用的云主机因为配置成本较高，会限制次数，每个实验不超过6次**


## 二、主要知识点

### 2.1 主要知识点

实验的操作部分在 Kali 虚拟机上进行，对于其中的 DNS 隧道技术，要先了解 DNS 是什么，以及 DNS 隧道技术的应用。常见的 DNS 隧道技术实现的工具有哪些。本实验主要介绍 DNS2TCP 在 DNS 数据中维持 TCP 连接的原理，其重点知识列表如下所示：

- DNS 的基本概念含义
- TCP、UDP 两者的概念以及区别
- TCP 的三次握手
- DNS 隧道实现工具有哪些

## 三、 DNS 基本介绍

### 3.1 DNS 基本概念

网域名称系统（Domain Name System），缩写为 DNS，是互联网的一项服务。它作为将域名和 IP 地址相互映射的一个分布式数据库，能够使人更方便地访问互联网。`DNS 使用 TCP 和 UDP 端口 53`。当前，对于每一级域名长度的限制是 63 个字符，域名总长度则不能超过 253 个字符。

而其中有两个很重要的协议需要弄掌握，即 TCP 协议和 UDP协议。充分理解这两个协议，有助于更好地掌握如何使用 DNS2TCP 在 DNS 数据流中维持 TCP 连接这一实验。

### 3.2 TCP、UDP 的概念以及两者的区别

传输控制协议 TCP 的全名为 Transmission Control Protocol，其中有三点比较值得注意：
- 提供 IP 环境下的数据可靠传输（一台计算机发出的字节流会无差错的发往网络上的其他计算机，而且计算机A接收数据包的时候，也会向计算机B回发数据包，这也会产生部分通信量），有效流控，全双工操作（数据在两个方向上能同时传递），多路复用服务，是面向连接，端到端的传输。
- 面向连接：正式通信前必须要与对方建立连接。即在数据发送前，事先将开辟好的数据连接通道。
- TCP 支持的应用协议：Telnet（远程登录）、FTP（文件传输协议）、SMTP（简单邮件传输协议）。TCP用于传输数据量大，可靠性要求高的应用。


![图片描述](https://dn-simplecloud.shiyanlou.com/uid/ff207c4ac994ae597a753f238bd6b2de/1481683173674.png-wm)
> 图来自维基百科传输控制协议

与 TCP 协议经常一起出现的，叫用户数据报协议 UDP，全名为 User Data Protocol，其中有两点值得注意：
- 面向非连接的，不能提供可靠性、流控、差错恢复功能。UDP 用于一次只传送少量数据，可靠性要求低、传输经济等应用。
- UDP 支持的应用协议：NFS (网络文件系统)、SNMP (简单网络管理系统)、DNS (主域名称系统)、TFTP (通用文件传输协议)等。



![图片描述](https://dn-simplecloud.shiyanlou.com/uid/ff207c4ac994ae597a753f238bd6b2de/1481684162270.png-wm)


在了介绍了 TCP 协议与 UDP 协议这两个重要概念之后，我们对这两个协议做一个总结：

| 概念名称           | 特点总结                                                     |
| ------------------ | ------------------------------------------------------------ |
| 传输控制协议 TCP   | 面向连接、传输可靠(保证数据正确性,保证数据顺序)、用于传输大量数据(流模式)、速度慢，建立连接需要开销较多(时间，系统资源)。 |
| 用户数据报协议 UDP | 面向非连接、传输不可靠、用于传输少量数据(数据包模式)、速度快。 |

> 部分参考百度经验：http://jingyan.baidu.com/

### 3.3 TCP 的三次握手

在了解了 DNS 的概念，以及 TCP 协议和 UDP 协议的区别之后，下面我们再对 TCP 三次握手这一过程进行一个详细地讲解。通常情况下，在数据传输过程中建立起一个 TCP 连接需要经过“三次握手”：

- 第一次握手：客户端发送 syn 包（syn=j）到服务器，并进入 SYN_SEND 状态，等待服务器确认。
- 第二次握手：服务器收到 syn 包，必须确认客户的SYN（ack=j+1），同时自己也发送一个 SYN 包（syn=k），即 SYN+ACK 包，此时服务器进入 SYN_RECV 状态。
- 第三次握手：客户端收到服务器的 SYN＋ACK 包，向服务器发送确认包 ACK（ack=k+1），此包发送完毕，客户端和服务器进入 ESTABLISHED 状态，完成三次握手。

![图片描述](https://dn-simplecloud.shiyanlou.com/uid/ff207c4ac994ae597a753f238bd6b2de/1481698984593.png-wm)

## 四、 DNS 隧道技术

### 4.1 DNS 隧道技术介绍

上文的 3.1 小节介绍了 DNS 概念，我们接下来对 DNS 隧道技术进行讲解。隧道技术（Tunneling）是一种通过使用互联网络的基础设施在网络之间传递数据的方式。使用隧道传递的数据（或负载）可以是不同协议的数据帧或包。隧道协议将其它协议的数据帧或包重新封装然后通过隧道发送。新的帧头提供路由信息，以便通过互联网传递被封装的负载数据。

这里常见的 DNS 隧道工具集合如下列表：

- OzymanDNS，使用 Perl 语言实现
- Iodine，使用 C 语言实现
- Tcp-over-dns，使用 Java 语言实现
- Dns2tcp，使用 C 语言实现
- heyoka，使用 C 语言实现 

### 4.2 DNS 隧道技术的原理

DNS 隧道技术可以分为直连和中继两种。一般情况下，我们请求查询域名的时候，当在 DNS 查询的过程中，如果所查询的域名不在 DNS 服务器本机的 cache 中，则会到互联网上进行查询，并把最终查询结果反馈回来。如果用户在互联网上有一台定制的服务器，`那么只要依靠 DNS 这层约定，就可以交换数据包`。

而从 DNS 协议来看，当每一次查询一个特定的域名，则会得到相应的解析结果。而在这过程中，如果没有直接连接到局域网外的机器，则网关不会转发用户的 IP 包，但是局域上的 DNS 则会帮助用户做一次中转，这就是 DNS 隧道的原理。

平时日常生活中，当连接上 wifi 时，可以向这个服务器的 53 端口发送数据，请求一个域名，由于请求的这台服务器上没有该域名，所以它将转向 `根服务器` 请求，查询根服务器是否存在这个域名。实现隧道技术的工具有很多，早期的如 NSTX，Ozymandns，而目前比较热门的有 Iodine，Dnscat2，以及 Dns2tcp 等。

### 4.3 DNS 隧道工具 DNS2TCP 使用介绍

DNS 隧道工具  DNS2TCP 分为两部分，一部分为服务器端 dns2tcpd，另一部分为客户端 dns2tcpc。服务器功能为在配置文件中指定的资源的列表。每个资源是本地或远程服务监听 TCP 连接。客户端则是侦听一个预定义的 TCP 端口。

DNS2TCP 利用合法的 DNS 服务器实现了 DNS 隧道，其中的重点在于利用 dns2tcpc 和 dns2tcpd 作为客户端和服务端，通过 TXT 记录机密传输数据，从而实现数据传输连接。

### 1. DNS 域名解析配置

由于该实验的操作比较特殊，实验基于实验楼的环境，Kali 训练营实验教程具备一定的攻击性。为了防止实验楼或者其他网站受到攻击，所以所有实验均处于断网状态。

由 DNS 隧道原理知道，当在做 DNS 查询的时候，如果查的域名在 DNS 服务器本机的 cache 中没有，它就会去互联网上查询，最终把查询到的结果返回给你。

本实验中，DNS2TCP 的服务器端和客户端的之间，能够相互地通信的前提，需要一台 DNS 服务器做为中转。DNS 服务器作为桥梁，将两者的数据连接起来。本实验涉及到外网的连接，以及域名解析，所以对于 DNS 隧道技术了解其原理和流程即可。

首先第一步，得将你的一个域名（以 shiyanlou.com 为例），解析设置一个二级域名 `a.shiyanlou.com`，其类型为 NS。接着将 NS 指向 `b.shiyanlou.com`，再以 `b.shiyanlou.com` 建立一个类型为 A 的记录，最后将 A 指向你的服务器 IP 地址。

```
Ns   a  默认  b.shiyanlou.com
A    b  默认  你的服务器IP地址
```

如果解析这一步不会，可以向你所购买域名的服务商客服进行询问，不同的服务商域名设置控制面板操作可能会有所差异。

### 2. DNS2TCP 服务器端

接下来输入帮助命令，查看 DNS2TCP 服务器端的工具的参数使用。在 Kali 终端中，输命令 `dns2tcpd`，可以看到帮助信息：

![图片描述](https://dn-simplecloud.shiyanlou.com/uid/212008/1481771537147.png-wm)

其中的参数含义表格如下：

| 参数名称 | 参数所代表的意思                                            |
| -------- | ----------------------------------------------------------- |
| `-i`     | 该参数用于指定的 IP 地址                                    |
| `-F`     | 该参数的意思是 `dns2tcp` 命令触发的服务器端程序将运行在前台 |
| `-f`     | 小写的 `-f` 意思为读取定 DNS2TCP 的服务器配置文件           |
| `-d`     | 用于指定开启的 Debug 等级                                   |

通常情况下， 用于启动 DNS2TCP 服务器端的配置文件放在 `/etc` 这个文件夹下，文件名为 `dns2tcp.conf`，配置文件基本内容如下：

```
# 填写Linux 服务器的 IP 地址
listen = X.X.X.X

# 主机上的端口号
port = 53

# 主机上的用户
user = nobody

# 默认文件夹 tmp
chroot = /tmp

# 配置域名服务器 NS 记录的域名
domain = XXXXXXXX

# 配置的是 DNS2TCP 供客户端使用的资源
resources = ssh:127.0.0.1:22, socks:127.0.0.1:1082, http:127.0.0.1:3128
```
其中，`resources` 里面配置的是 DNS2TCP 供客户端使用的资源。作用是在本地监听一个端口，并指定使用的资源。一旦 DNS2TCP 将数据由 DNS 协议转到这，服务器会将数据转到指定的资源配置对口中。从而使用该端口的相应服务。

当上面的配置完成之后，输入如下命令，运行服务器端程序：

```
dns2tcpd -f /etc/dns2tcpd.conf
```
其中用于关闭 DNS2TCP 服务器端的命令为：

```
kill all dns2tcpd
```

### 3. DNS2TCP 客户端

**这里值得注意的是，能成功的前提为，解析域名的 DNS 记录生效后，才能够正常的使用客户端，由于实验楼环境的特殊性，未能联网，所以无法访问外网的 DNS 服务器**

下面继续讲解 DNS2TCP 客户端隧道工具的使用，及其配置含义。本实验理解 DNS2TCP 在 DNS 隧道技术中的使用流程和原理即可。在实验楼 Kali 终端中，输入帮助命令 `dns2tcpc`，可以查看 DNS 客户端的具体参数信息：

![图片描述](https://dn-simplecloud.shiyanlou.com/uid/212008/1481772378890.png-wm)

其中客户端器端的参数含义表格如下：

| 参数名称      | 参数多代表含义                                             |
| ------------- | ---------------------------------------------------------- |
| `-c`          | 该参数用于启用压缩                                         |
| `-z <domain>` | 用于指定所用的域名                                         |
| `-r`          | 用于指定连接服务的名称                                     |
| `-z`          | 连接 NS 记录的所使用的域名                                 |
| `-T`          | DNS 的请求类型，默认为 txt 文本                            |
| `-l`          | 该参数用于指定监听本地的端口                               |
| `-d`          | 用于指定开启的 Debug 等级，输出相关级别日志，默认为1，2，3 |

而客户端使用的命令则很简单，输入如下命令即可，使用服务器的 `ssh` 功能：

```
dns2tcpc -r ssh -z a.shiyanlou.com X.X.X.X -l 8888 -d 2
```

该工具的使用，和 Socket 连接有点类似。服务器监听，客户端连接，只不过较 Socket 而言，DNS2TCP 多了一个重要的中转。

## 五、思考总结

### 5.1 思考与总结

本实验主要介绍了使用 DNS2TCP 在 DNS 数据流中维持 TCP 连接的原理，其中还包括了 DNS2TCP 服务器端和客户端的配置问题，其中还介绍了 TCP 协议和 UDP 协议的概念和区别。本实验的主要知识结构如下图所示：

![图片描述](https://dn-simplecloud.shiyanlou.com/uid/ff207c4ac994ae597a753f238bd6b2de/1481815366811.png-wm)


## 六、课后作业

### 6.1 课后阅读

本文概念性较多，其中主要讲解了 TCP 传输控制协议特点，UDP 用户数据报特点，以及两者的区别。并在实验中列举了实现 DNS 隧道技术的工具。其中实验的成功，需要域名解析设置 NS 记录和 A 记录类型。
部分内容参考内容如下：

> 程序员的世界：http://www.voidcn.com/blog/god_7z1/article/p-4819727.html

对于工具的使用，感兴趣的同学也可以阅读官方英文档：

> http://tools.kali.org/maintaining-access/dns2tcp